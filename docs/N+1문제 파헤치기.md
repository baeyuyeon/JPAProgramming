## âœ” N+1ë¬¸ì œë€?
ì—°ê´€ê´€ê³„ê°€ ì„¤ì •ëœ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ê²½ìš°ì— ì¡°íšŒí•œ ë°ì´í„° ê°¯ìˆ˜(N)ë§Œí¼ ì—°ê´€ê´€ê³„ì˜ ì¶”ê°€ì¿¼ë¦¬ê°€ ì¶”ê°€ë¡œ ë°œìƒí•˜ì—¬ ë°ì´í„°ë¥¼ ì½ì–´ì˜¤ëŠ” í˜„ìƒ

## âœ”ì–¸ì œ ë°œìƒí• ê¹Œìš”?
@ManyToOne ê´€ê³„ë¥¼ ê°€ì§„ ì—”í‹°í‹°ì—ì„œ ì£¼ë¡œ ë°œìƒí•œë‹¤.
ë°ì´í„° ì¡°íšŒì‹œ 
- ì¦‰ì‹œ ë¡œë”©ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²½ìš°ëŠ” N+1í˜„ìƒì´ ë°”ë¡œ ë°œìƒí•œë‹¤.
- ì§€ì—°ë¡œë”©ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ ì´í›„ì— ê°€ì ¸ì˜¨ ë°ì´í„°ì—ì„œ í•˜ìœ„ ì—”í‹°í‹°ë¥¼ ë‹¤ì‹œ ì¡°íšŒí•˜ëŠ” ê²½ìš° N+1í˜„ìƒì´ ë°œìƒí•œë‹¤.

## âœ” N+1 í˜„ìƒ ì¬í˜„í•´ë³´ê¸°.
í•­ìƒí•˜ëŠ” Memberì™€ Teamìœ¼ë¡œ ì¬í˜„í•´ë³´ê² ë‹¤.
```java
@Entity
public class Member10_2_7 {

    @Id
    @Column(name = "MEMBER_ID")
    private String id;
    private String username;

    @ManyToOne
    @JoinColumn(name = "TEAM_ID")
    private Team10_2_7 team;

    public Member10_2_7() {
    }

    public Member10_2_7(String id, String username) {
        this.id = id;
        this.username = username;
    }
	//...getter, setter
}
@Entity
public class Team10_2_7 {

    @Id
    @Column(name = "TEAM_ID")
    private String id;
    private String name;

    @OneToMany(mappedBy = "team")
    private List<Member10_2_7> members = new ArrayList<>();

    public Team10_2_7() {
    }

    public Team10_2_7(String id, String name) {
        this.id = id;
        this.name = name;
    }

    public List<Member10_2_7> getMembers() {
        return members;
    }
    //...getter, setter
}


```
![](https://velog.velcdn.com/images/baeyuyeon/post/62daec9f-db29-4663-aec7-099afe0b26fb/image.png)
ë©¤ë²„ê°€ í•œ íŒ€ì— ì†Œì†ë˜ì–´ìˆê³  í•œ íŒ€ì€ ì—¬ëŸ¬ ë©¤ë²„ë¥¼ í¬í•¨í•  ìˆ˜ ìˆëŠ” N:1(ë©¤ë²„:íŒ€)ê´€ê³„ì´ë‹¤.


![](https://velog.velcdn.com/images/baeyuyeon/post/7c346f03-d902-4167-87ca-b364d0fc53bc/image.png)

![](https://velog.velcdn.com/images/baeyuyeon/post/dfc21093-30dc-4740-9ad8-c47f1530f312/image.png)



### ğŸ”»ì¦‰ì‹œë¡œë”©ì¼ ê²½ìš°
Memberì˜ Team ê°ì²´ ì°¸ì¡°ëŠ” @ManyToOneë¡œ ì—°ê´€ê´€ê³„ê°€ ì„¤ì •ë˜ì–´ìˆë‹¤. `@ManyToOne`ì˜ ê¸°ë³¸ íŒ¨ì¹˜ ì „ëµì€ ì¦‰ì‹œë¡œë”©ì´ë¯€ë¡œ ë³„ë„ ì„¤ì •ì„ í•˜ì§€ ì•Šê³  ì¡°íšŒë¥¼ í•´ë³´ê² ë‹¤.

```java
String query2 = "SELECT m FROM Member10_2_7 m inner join m.team t";

List<Member10_2_7> members = em.createQuery(query2, Member10_2_7.class).getResultList();
```
ìœ„ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ ì¿¼ë¦¬ê°€ ìˆ˜í–‰ëœë‹¤.
```sql
Hibernate: 
    select
            member10_2x0_.MEMBER_ID as MEMBER_I1_20_,
            member10_2x0_.TEAM_ID as TEAM_ID3_20_,
            member10_2x0_.username as username2_20_ 
        from
            Member10_2_7 member10_2x0_ 
        inner join
            Team10_2_7 team10_2_7x1_ 
                on member10_2x0_.TEAM_ID=team10_2_7x1_.TEAM_ID
Hibernate: 
    select
        team10_2_7x0_.TEAM_ID as TEAM_ID1_47_0_,
        team10_2_7x0_.name as name2_47_0_ 
    from
        Team10_2_7 team10_2_7x0_ 
    where
        team10_2_7x0_.TEAM_ID=?
Hibernate: 
    select
        team10_2_7x0_.TEAM_ID as TEAM_ID1_47_0_,
        team10_2_7x0_.name as name2_47_0_ 
    from
        Team10_2_7 team10_2_7x0_ 
    where
        team10_2_7x0_.TEAM_ID=?
Hibernate: 
    select
        team10_2_7x0_.TEAM_ID as TEAM_ID1_47_0_,
        team10_2_7x0_.name as name2_47_0_ 
    from
        Team10_2_7 team10_2_7x0_ 
    where
        team10_2_7x0_.TEAM_ID=?

```
ì¦‰, ë©¤ë²„ì— ì—°ê´€ëœ íŒ€ì˜ ê°œìˆ˜(3)ë§Œí¼ 3ê°œì˜ ì¿¼ë¦¬ê°€ ì¶”ê°€ë¡œ ë°œìƒí•˜ëŠ” N+1í˜„ìƒì´ ë°œìƒí•œë‹¤.

### ğŸ”»ì§€ì—°ë¡œë”©ì¼ ê²½ìš°
ìš°ì„  ì§€ì—°ë¡œë”©ì„¤ì •ì„ ìœ„í•´ Memberì—ì„œ team ì°¸ì¡° íŒ¨ì¹˜ì „ëµì„ ì§€ì—°ë¡œë”©ìœ¼ë¡œ ì„¤ì •í•´ë‘ì.
`@ManyToOne(fetch = FetchType.LAZY)`ë¡œ ì„¤ì •!
ì„¤ì •í•œ í›„, ìœ„ì™€ ë˜‘ê°™ì´ ì¡°íšŒ ì½”ë“œë¥¼ ë‚ ë¦¬ë©´ ì–´ë–»ê²Œ ë ê¹Œ?
```java
String query2 = "SELECT m FROM Member10_2_7 m inner join m.team t";

List<Member10_2_7> members = em.createQuery(query2, Member10_2_7.class).getResultList();
```
```sql
Hibernate: 
    select
            member10_2x0_.MEMBER_ID as MEMBER_I1_20_,
            member10_2x0_.TEAM_ID as TEAM_ID3_20_,
            member10_2x0_.username as username2_20_ 
       from
           Member10_2_7 member10_2x0_ 
       inner join
           Team10_2_7 team10_2_7x1_ 
               on member10_2x0_.TEAM_ID=team10_2_7x1_.TEAM_ID
```
ìš°ë¦¬ê°€ ì›í•˜ë˜ëŒ€ë¡œ ì¿¼ë¦¬ê°€ 1ë²ˆë§Œ ì‹¤í–‰ì´ ë˜ì—ˆë‹¤! ì´ë ‡ê²Œ N+1í˜„ìƒì€ ë°œìƒë˜ì§€ ì•Šì„ê¹Œ?
_ê·¸ë ‡ì§€ ì•Šë‹¤._
ì´ì œ Memberì˜ íŒ€ëª…ì„ ì¡°íšŒí•˜ëŠ” ì½”ë“œë¥¼ ì¶”ê°€í•´ë³´ì.
```java
for (Member10_2_7 member : members) {
	Team10_2_7 team = member.getTeam();
    String name = team.getName();
    System.out.println("name = " + name);
}
```
ìœ„ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´,
```sql
Hibernate: 
    select
        team10_2_7x0_.TEAM_ID as TEAM_ID1_47_0_,
        team10_2_7x0_.name as name2_47_0_ 
    from
        Team10_2_7 team10_2_7x0_ 
    where
        team10_2_7x0_.TEAM_ID=?
name = íŒ€A
Hibernate: 
    select
        team10_2_7x0_.TEAM_ID as TEAM_ID1_47_0_,
        team10_2_7x0_.name as name2_47_0_ 
    from
        Team10_2_7 team10_2_7x0_ 
    where
        team10_2_7x0_.TEAM_ID=?
name = íŒ€B
Hibernate: 
    select
        team10_2_7x0_.TEAM_ID as TEAM_ID1_47_0_,
        team10_2_7x0_.name as name2_47_0_ 
    from
        Team10_2_7 team10_2_7x0_ 
    where
        team10_2_7x0_.TEAM_ID=?
name = íŒ€C
```
ì—­ì‹œ íŒ€ì˜ ê°œìˆ˜ë§Œí¼ Nê°œì˜ ì¶”ê°€ ì¿¼ë¦¬ê°€ ë°œìƒí•œë‹¤.

## âœ” N+1í˜„ìƒ í•´ê²°ë°©ë²•
N+1í˜„ìƒ í•´ê²°ë°©ë²•ì€ ëŒ€í‘œì ìœ¼ë¡œ ì„¸ê°€ì§€ê°€ ìˆëŠ”ë°, Fetch join ì‚¬ìš©, @EntityGraph, Batch Size ì˜µì…˜ ì„¤ì •ë°©ë²•ì´ ìˆë‹¤.
í•´ë‹¹ ê¸€ì—ì„œëŠ” Fetch joinë§Œ ì„¤ëª…í•˜ê³  ë‚˜ë¨¸ì§€ ë°©ë²•ì€ ì¶”í›„ ì¶”ê°€í•˜ê² ë‹¤.

---
## âœ” Fetch join 
### ğŸ”¶Fetch Join ì´ë€?
Fetchë€ ê°€ì ¸ì˜¤ë‹¤ë¼ëŠ” ëœ»ì´ë‹¤. Fetchë¼ëŠ” ëœ»ì— ê±¸ë§ê²Œ íŒ¨ì¹˜ì¡°ì¸ì„ ì‚¬ìš©í•˜ë©´ ì—°ê´€ëœ Entity ë¥¼ ëª¨ë‘ ì¦‰ì‹œ ë¡œë”©ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.

### ğŸ”¶Fetch Join ì‚¬ìš©í•˜ê¸°
join fetch ì´ë¼ëŠ” êµ¬ë¬¸ì„ ì‚¬ìš©í•´ì„œ ë°ì´í„°ë¥¼ ì¡°íšŒí•œë‹¤.

```java
private static void fetchJoin(EntityManager em) {
	String query = "select m from Member10_2_7 m join fetch m.team";

    List<Member10_2_7> members = em.createQuery(query,  Member10_2_7.class).getResultList();

	System.out.println("members = " + members);
}
    
```
ìœ„ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´?
```sql
select
            member10_2x0_.MEMBER_ID as MEMBER_I1_20_0_,
            team10_2_7x1_.TEAM_ID as TEAM_ID1_47_1_,
            member10_2x0_.TEAM_ID as TEAM_ID3_20_0_,
            member10_2x0_.username as username2_20_0_,
            team10_2_7x1_.name as name2_47_1_ 
        from
            Member10_2_7 member10_2x0_ 
        inner join
            Team10_2_7 team10_2_7x1_ 
                on member10_2x0_.TEAM_ID=team10_2_7x1_.TEAM_ID
                
members = [Member10_2_7{id='member1', username='ë©¤ë²„ì¼', team=Team10_2_7{id='team1', name='íŒ€A'}}, Member10_2_7{id='member2', username='ë©¤ë²„ì´', team=Team10_2_7{id='team2', name='íŒ€B'}}, Member10_2_7{id='member3', username='ë©¤ë²„ì‚¼', team=Team10_2_7{id='team3', name='íŒ€C'}.....}]
```
ì´ì™€ ê°™ì´ 1ê°œì˜ ì¿¼ë¦¬ë§Œ ì‹¤í–‰ë˜ì–´ í•œë²ˆì— ëª¨ë“  ë°ì´í„°ë¥¼ ë‹¤ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.

### ğŸ”¶Fetch Join ì‚¬ìš©ì‹œ ì£¼ì˜ì  - on ì‚¬ìš© ê¸ˆì§€
```sql
select m from Member10_2_7 m join fetch m.team t on t.name='íŒ€B'";
```
ë‹¤ìŒê³¼ ê°™ì´ onì„ ì‚¬ìš©í•˜ì§€ ë§ë¼ëŠ”ë§ì´ë‹¤._(ìœ„ ì¿¼ë¦¬ì—ëŠ” ì‚¬ì‹¤ ë‘ê°€ì§€ì˜ ë¬¸ì œê°€ ìˆë‹¤.)_
Onì ˆì€ Joinì´ ë˜ê¸°ì „ í•„í„°ë§ì„ ê±°ëŠ” ê²ƒì¸ë°, Fetch Join ì€ ì—°ê´€ëœ Entityë‚˜ Collectionì„ ëª¨ë‘ ê°€ì ¸ì˜¨ë‹¤ëŠ” ì˜ë¯¸ë¡œ onì€ ë¶ˆê°€ëŠ¥í•˜ë‹¤.
ë”°ë¼ì„œ whereì ˆì„ ì‚¬ìš©í•´ì„œ ì´ë¯¸ ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ í•„í„°ë§í•˜ë©´ ëœë‹¤.
**ê·¸ë ‡ì§€ë§Œ, whereì ˆì„ í†µí•´ì„œ Entityì˜ ìƒíƒœê°€ ì†ìƒë  ìˆ˜ ìˆì–´ì„œ ì£¼ì˜í•´ì„œ ì‚¬ìš©í•´ì•¼í•œë‹¤.**

### ğŸ”¶Fetch Join ì‚¬ìš©ì‹œ ì£¼ì˜ì  - Fetch Join ëŒ€ìƒì— ë³„ì¹­ì£¼ê¸° ê¸ˆì§€

JPA ìŠ¤í™ì—ì„œëŠ” Fetch Join ëŒ€ìƒì— ë³„ì¹­ì„ ì£¼ëŠ” ê²ƒì„ ê¸ˆì§€í•˜ê³  ìˆë‹¤.
ì™œëƒí•˜ë©´ ë³„ì¹­ì„ ì´ìš©í•´ whereì¡°ê±´ì„ ì‚¬ìš©í•˜ë©´ ì—°ê´€ëœ Entityê°€ ì†ìƒë  ìˆ˜ ìˆê³ , DBì¼ê´€ì„±ì— ì˜í–¥ì´ ìƒê¸¸ ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤.
```sql
select m from Member10_2_7 m join fetch m.team t where t.name='íŒ€B'
```
ìœ„ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´?
```sql
select
	member10_2x0_.MEMBER_ID as MEMBER_I1_20_0_,
    team10_2_7x1_.TEAM_ID as TEAM_ID1_47_1_,
    member10_2x0_.TEAM_ID as TEAM_ID3_20_0_,
    member10_2x0_.username as username2_20_0_,
    team10_2_7x1_.name as name2_47_1_ 
from
	Member10_2_7 member10_2x0_ 
    inner join
	Team10_2_7 team10_2_7x1_ 
    	on member10_2x0_.TEAM_ID=team10_2_7x1_.TEAM_ID 
where
	team10_2_7x1_.name='íŒ€B'
```
ì˜ë§Œ ì‹¤í–‰ëœë‹¤... ê·¸ ì´ìœ ëŠ”, JPAêµ¬í˜„ì²´ì¸ Hibernateì—ì„œ Fetch Join ì˜ ëŒ€ìƒì— Aliasë¥¼ ì£¼ëŠ” ê²ƒì„ í—ˆìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì´ë‹¤.
ê·¸ë ‡ì§€ë§Œ ì•ˆì“°ëŠ”ê²Œ ì¢‹ìœ¼ë‹ˆ, Entityì˜ ìˆœì„œë¥¼ ë°”ê¿”ì„œ Fetch Joinì˜ ëŒ€ìƒì´ ì•ˆë˜ë„ë¡ ë°”ê¿”ë³´ì.
```java
String query = "select t from Team10_2_7 t join fetch t.members where t.name='íŒ€B'";

List<Team10_2_7> teams = em.createQuery(query, Team10_2_7.class).getResultList();
for (Team10_2_7 team : teams) {
	System.out.println("team.getMembers() = " + team.getMembers());
}
```
ìœ„ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ ë»¥íŠ€ê¸° ì¡°íšŒê°€ ëœë‹¤.
```sql
select
            team10_2_7x0_.TEAM_ID as TEAM_ID1_47_0_,
            members1_.MEMBER_ID as MEMBER_I1_20_1_,
            team10_2_7x0_.name as name2_47_0_,
            members1_.TEAM_ID as TEAM_ID3_20_1_,
            members1_.username as username2_20_1_,
            members1_.TEAM_ID as TEAM_ID3_20_0__,
            members1_.MEMBER_ID as MEMBER_I1_20_0__ 
        from
            Team10_2_7 team10_2_7x0_ 
        inner join
            Member10_2_7 members1_ 
                on team10_2_7x0_.TEAM_ID=members1_.TEAM_ID 
        where
            team10_2_7x0_.name='íŒ€B'
team.getMembers() = [Member10_2_7{id='member2', username='ë©¤ë²„ì´', team=Team10_2_7{id='team2', name='íŒ€B'}}, Member10_2_7{id='member5', username='ë©¤ë²„ì˜¤', team=Team10_2_7{id='team2', name='íŒ€B'}}]
team.getMembers() = [Member10_2_7{id='member2', username='ë©¤ë²„ì´', team=Team10_2_7{id='team2', name='íŒ€B'}}, Member10_2_7{id='member5', username='ë©¤ë²„ì˜¤', team=Team10_2_7{id='team2', name='íŒ€B'}}]

```

ë»¥íŠ€ê¸° ì¡°íšŒë¥¼ ë§‰ê¸°ìœ„í•´ distinct ë¥¼ ì‚¬ìš©í•œë‹¤.
`select distinct(t) from Team10_2_7 t join fetch t.members where t.name='íŒ€B'`

>ì´ì™¸ì—ë„ ì¼ëŒ€ë‹¤ Fetch Joinì€ í•œê³„ì ì´ ë§ë‹¤.
aliasì— ê´€í•œ ë‹¨ì , ë»¥íŠ€ê¸° ì¡°íšŒ, ì¼ëŒ€ë‹¤ ì¡°ì¸ 2ê°œ ì´ìƒë¶ˆê°€, í˜ì´ì§•ì²˜ë¦¬ë¶ˆê°€ë“±ì˜ ë‹¨ì ì´ ìˆë‹¤.

### ğŸ”¶Fetch Join ì‚¬ìš©ì‹œ ì£¼ì˜ì  - Fetch Join ëŒ€ìƒì— ë³„ì¹­ì£¼ê¸°ë¥¼ ì™œí•˜ë©´ ì•ˆë˜ëŠ”ê°€?
Fetch join ì— Alias ë¥¼ ì¤˜ì„œ ìƒê¸°ëŠ” ë¬¸ì œëŠ” ë³´í†µ ì¼ëŒ€ë‹¤ ì¡°ê±´ì—ì„œ ë°œìƒí•œë‹¤.
ì¼ëŒ€ë‹¤ ì¡°ê±´ì—ì„œ ì»¬ë ‰ì…˜ ëŒ€ìƒì€ ì–´ë–¤ ì¡°ê±´ì„ ê±¸ë“  ëª¨ë“  ë°ì´í„°ê°€ ë‚˜ì˜¤ëŠ”ê²Œ ì •ìƒì´ë‹¤. 

ë©¤ë²„ ëª…ì´ `ë©¤ë²„ì¼` ì¸ ë°ì´í„°ë¥¼ ì¡°íšŒí•´ë³´ì.
#### ì¼ë‹¨, fetch joinì„ ì‚¬ìš©í•˜ì§€ ì•Šì•˜ì„ ë•Œë¥¼ ë³´ì.
```java
String query = "select t from Team10_2_7 t join t.members m where m.username='ë©¤ë²„ì¼'";
List<Team10_2_7> teams = em.createQuery(query, Team10_2_7.class).getResultList();
for (Team10_2_7 team : teams) {
	System.out.println("team.getMembers() = " + team.getMembers());
}
```
ì‹¤í–‰ê²°ê³¼ëŠ”?
```sql
select
            team10_2_7x0_.TEAM_ID as TEAM_ID1_47_,
            team10_2_7x0_.name as name2_47_ 
        from
            Team10_2_7 team10_2_7x0_ 
        inner join
            Member10_2_7 members1_ 
                on team10_2_7x0_.TEAM_ID=members1_.TEAM_ID 
        where
            members1_.username='ë©¤ë²„ì¼'
Hibernate: 
    select
        members0_.TEAM_ID as TEAM_ID3_20_0_,
        members0_.MEMBER_ID as MEMBER_I1_20_0_,
        members0_.MEMBER_ID as MEMBER_I1_20_1_,
        members0_.TEAM_ID as TEAM_ID3_20_1_,
        members0_.username as username2_20_1_ 
    from
        Member10_2_7 members0_ 
    where
        members0_.TEAM_ID=?
team.getMembers() = 
[Member10_2_7{id='member1', username='ë©¤ë²„ì¼', team=Team10_2_7{id='team1', name='íŒ€A'}}, 
Member10_2_7{id='member4', username='ë©¤ë²„ì‚¬', team=Team10_2_7{id='team1', name='íŒ€A'}}]

```
ê²°ê³¼ë¥¼ ë³´ë©´, `ë©¤ë²„ì¼` ë¿ë§Œ ì•„ë‹ˆë¼ `ë©¤ë²„ì‚¬`ë„ ì¡°íšŒë¥¼ í•´ì˜¨ë‹¤. 
ì™œëƒí•˜ë©´ ì²«ë²ˆì§¸ì¿¼ë¦¬ì—ì„œ ë©¤ë²„ì¼ì¸ íŒ€ì€ 'team1' ì´ê³  'team1'ì— í•´ë‹¹í•˜ëŠ” memberëŠ” ì¶”ê°€ì¿¼ë¦¬ë¥¼ í†µí•´ì„œ ë‘ëª…ìœ¼ë¡œ ì¡°íšŒë˜ê¸° ë•Œë¬¸ì´ë‹¤.
ì´ê²Œ ë§ëŠ”ê²ƒì´ë‹¤! 
JPQLì€ SQLì´ ì•„ë‹ˆë¼ ê°ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ê¸° ë•Œë¬¸ì— ê°ì²´ê´€ê³„ì˜ ìœ ì§€ë¥¼ ìœ„í•´ í•´ë‹¹ ê°ì²´ì— í•´ë‹¹í•˜ëŠ” ì—°ê´€ Collectionë°ì´í„°ëŠ” ëª¨ë‘ ê°–ê³  ìˆì–´ì•¼í•œë‹¤.
(ì¦‰, team1ì—ëŠ” ë©¤ë²„ì¼ê³¼ ë©¤ë²„ì‚¬ ë‘ ëª…ì´ ëª¨ë‘ ìˆì–´ì•¼í•œë‹¤.)

#### ì´ì œ fetch joinì„ ì‚¬ìš©í•´ì„œ ë¬¸ì œë¥¼ ë§Œë“¤ì–´ë³´ì.
```java
String query = "select t from Team10_2_7 t join fetch t.members m where m.username='ë©¤ë²„ì¼'";

        List<Team10_2_7> teams = em.createQuery(query, Team10_2_7.class).getResultList();
        for (Team10_2_7 team : teams) {
            System.out.println("team.getMembers() = " + team.getMembers());
        }
```
ê²°ê³¼ëŠ”?
```sql
team.getMembers() = [Member10_2_7{id='member1', username='ë©¤ë²„ì¼', team=Team10_2_7{id='team1', name='íŒ€A'}}]
```
ì´ë ‡ê²Œ ë©¤ë²„ì¼ í•œëª…ë§Œ ì¡°íšŒëœë‹¤. ì¦‰, Collectionë°ì´í„°ê°€ ë¶ˆì™„ì „í•œ ìƒíƒœë¡œ ì¡°íšŒëœë‹¤.

ì´ì œ ì´ëŸ¬í•œ ë¬¸ì œë¡œ ì–´ë–¤ ë¬¸ì œê°€ ì´ˆë˜ë˜ëŠ”ì§€ ë³´ì.
```java
private static void fetchWrongUse(EntityManager em) {

        List<Team10_2_7> teams =
                em.createQuery("select distinct t from Team10_2_7 t join fetch t.members m "
                                        + "where m.username='ë©¤ë²„ì¼'",
                                Team10_2_7.class)
                        .getResultList(); //ë„Œ ì‚¬ìš©í•˜ì§€ ì•Šì„í…Œë‹¤.

        List<Team10_2_7> teams2 =
                em.createQuery("select distinct t from Team10_2_7 t join fetch t.members m "
                                , Team10_2_7.class)
                        .getResultList();

        for (Team10_2_7 team : teams2) {
            System.out.println("team.getMembers() = " + team.getMembers());
        }
    }
```
ìœ„ ì½”ë“œë¥¼ ë³´ë©´, teamsë¼ëŠ” ë³€ìˆ˜ëŠ” ì‹¤ì œ ì‚¬ìš©í•˜ì§€ì•ŠëŠ”ë‹¤. teamsë¼ëŠ” ë³€ìˆ˜ë§Œ ë£¨í”„ë¥¼ ëŒë ¤ ì¶œë ¥í•œë‹¤.
ì‹¤ì œ ì‹¤í–‰ê²°ê³¼ë¥¼ ë³´ì.
```sql
Hibernate: 
    select
            distinct team10_2_7x0_.TEAM_ID as TEAM_ID1_47_0_,
            members1_.MEMBER_ID as MEMBER_I1_20_1_,
            team10_2_7x0_.name as name2_47_0_,
            members1_.TEAM_ID as TEAM_ID3_20_1_,
            members1_.username as username2_20_1_,
            members1_.TEAM_ID as TEAM_ID3_20_0__,
            members1_.MEMBER_ID as MEMBER_I1_20_0__ 
        from
            Team10_2_7 team10_2_7x0_ 
        inner join
            Member10_2_7 members1_ 
                on team10_2_7x0_.TEAM_ID=members1_.TEAM_ID 
        where
            members1_.username='ë©¤ë²„ì¼'
Hibernate: 
    elect
            distinct team10_2_7x0_.TEAM_ID as TEAM_ID1_47_0_,
            members1_.MEMBER_ID as MEMBER_I1_20_1_,
            team10_2_7x0_.name as name2_47_0_,
            members1_.TEAM_ID as TEAM_ID3_20_1_,
            members1_.username as username2_20_1_,
            members1_.TEAM_ID as TEAM_ID3_20_0__,
            members1_.MEMBER_ID as MEMBER_I1_20_0__ 
        from
            Team10_2_7 team10_2_7x0_ 
        inner join
            Member10_2_7 members1_ 
                on team10_2_7x0_.TEAM_ID=members1_.TEAM_ID
team.getMembers() = [Member10_2_7{id='member1', username='ë©¤ë²„ì¼', team=Team10_2_7{id='team1', name='íŒ€A'}}]
team.getMembers() = [Member10_2_7{id='member2', username='ë©¤ë²„ì´', team=Team10_2_7{id='team2', name='íŒ€B'}}, Member10_2_7{id='member5', username='ë©¤ë²„ì˜¤', team=Team10_2_7{id='team2', name='íŒ€B'}}]
team.getMembers() = [Member10_2_7{id='member3', username='ë©¤ë²„ì‚¼', team=Team10_2_7{id='team3', name='íŒ€C'}}, Member10_2_7{id='member6', username='ë©¤ë²„ìœ¡', team=Team10_2_7{id='team3', name='íŒ€C'}}]
```
ì¼ë‹¨ ë‘ì¿¼ë¦¬ ëª¨ë‘ ì‹¤í–‰ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.
ê·¸ëŸ°ë° ë¬¸ì œëŠ” 'team1'ì— ì†í•œ 'member4'ê°€ ì¡°íšŒë˜ì§€ ì•Šì•˜ë‹¤ëŠ” ê²ƒì´ë‹¤.
ì´ìœ ëŠ”, ì²«ë²ˆì§¸ JPQLì—ì„œ ì½í˜€ì§„ Team ì˜ ì‹ë³„ì Idë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì—ˆê¸° ë•Œë¬¸ì´ë‹¤. 
JPQLì€ Entityê°€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì¡´ì¬í•˜ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤ì—ì„œ ë°ì´í„°ë¥¼ ì½ì–´ì˜¨ë‹¤.
ê·¸ëŸ¬ë¯€ë¡œ, `team1`ì´ë¼ëŠ” Idë¥¼ ì˜ì†ì„±ì»¨í…ìŠ¤íŠ¸ì— `member1`ë§Œ ë“¤ê³ ìˆê²Œ ì €ì¥ë˜ì–´ìˆê¸° ë•Œë¬¸ì— `member4`ëŠ” ë‚ ë¼ê°„ ê²ƒì´ë‹¤..

ìœ„ í˜„ìƒìœ¼ë¡œ ë³´ì•˜ì„ ë•Œ, ë¶ˆì™„ì „í•œ 2ì°¨ ìºì‹œë¥¼ ë¶ˆëŸ¬ì˜¤ê²Œ ëœë‹¤ë©´, ì¶”í›„ì— ì‚­ì œë‚˜ ìˆ˜ì •ì— ìˆì–´ì„œ ë¬¸ì œê°€ í¬ê²Œ ìƒê¸¸ ìˆ˜ ìˆë‹¤.

### ğŸ”¶Fetch Join ì¿¼ë¦¬ë¥¼ ì˜¬ë°”ë¥´ê²Œ ë°›ì•„ì˜¤ëŠ” ë°©ë²•
JPQLì„ ë°›ì•„ì˜¤ëŠ” ë°©ë²•ì„ Entity íƒ€ì…ì´ ì•„ë‹Œ ê°’íƒ€ì…ì¸ DTOë‚˜ Stateless Session ì„ í†µí•´ ë°›ì•„ì˜¤ëŠ” ê²ƒì´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šê³  ì˜¬ë°”ë¥´ê²Œ ì‚¬ìš© ê°€ëŠ¥í•œ ë°©ë²•ì´ë‹¤.

#### ğŸ”ºStateless Session(ë¬´ìƒíƒœ ì„¸ì…˜)
ë°ì´í„° ìŠ¤íŠ¸ë¦¬ë°ì— ì£¼ë¡œ ì‚¬ìš©ë˜ëŠ” Stateless Sessiondms 1ì°¨ìºì‹œ, 2ì°¨ìºì‹œì— ìƒê´€ì—†ì´ ì¡°íšŒëœë‹¤ëŠ” íŠ¹ì§•ì´ ìˆë‹¤. 
ê·¸ë ‡ê¸° ë•Œë¬¸ì— ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë°ì´í„°ê°€ ê¹¨ì§€ëŠ” ë¬¸ì œë¥¼ ì‹ ê²½ì“°ì§€ ì•Šì•„ë„ ëœë‹¤.
```java
private static void stateSessionUse(EntityManager em) {

	List<Team10_2_7> teams =
    	em.createQuery("select distinct t from Team10_2_7 t join fetch t.members m "
        	+ "where m.username='ë©¤ë²„ì¼'",
            	Team10_2_7.class).getResultList(); //ë„Œ ì‚¬ìš©í•˜ì§€ ì•Šì„í…Œë‹¤.

	Session session = em.unwrap(Session.class);
    SessionFactory sessionFactory = session.getSessionFactory();
    List<Team10_2_7> teams2 = session.doReturningWork(connection -> {
    	StatelessSession statelessSession = sessionFactory.openStatelessSession(connection);
		return statelessSession.createQuery(
        	"select distinct t from Team10_2_7 t join fetch t.members m "
            	, Team10_2_7.class).getResultList();
	});

    for (Team10_2_7 team : teams2) {
    	System.out.println("team.getMembers() = " + team.getMembers());
	}
}
```
ìœ„ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´,
```sql
Hibernate: 
    select
            distinct team10_2_7x0_.TEAM_ID as TEAM_ID1_47_0_,
            members1_.MEMBER_ID as MEMBER_I1_20_1_,
            team10_2_7x0_.name as name2_47_0_,
            members1_.TEAM_ID as TEAM_ID3_20_1_,
            members1_.username as username2_20_1_,
            members1_.TEAM_ID as TEAM_ID3_20_0__,
            members1_.MEMBER_ID as MEMBER_I1_20_0__ 
        from
            Team10_2_7 team10_2_7x0_ 
        inner join
            Member10_2_7 members1_ 
                on team10_2_7x0_.TEAM_ID=members1_.TEAM_ID 
        where
            members1_.username='ë©¤ë²„ì¼'
Hibernate: 
    select
            distinct team10_2_7x0_.TEAM_ID as TEAM_ID1_47_0_,
            members1_.MEMBER_ID as MEMBER_I1_20_1_,
            team10_2_7x0_.name as name2_47_0_,
            members1_.TEAM_ID as TEAM_ID3_20_1_,
            members1_.username as username2_20_1_,
            members1_.TEAM_ID as TEAM_ID3_20_0__,
            members1_.MEMBER_ID as MEMBER_I1_20_0__ 
        from
            Team10_2_7 team10_2_7x0_ 
        inner join
            Member10_2_7 members1_ 
                on team10_2_7x0_.TEAM_ID=members1_.TEAM_ID
team.getMembers() = [Member10_2_7{id='member1', username='ë©¤ë²„ì¼', team=Team10_2_7{id='team1', name='íŒ€A'}}, Member10_2_7{id='member4', username='ë©¤ë²„ì‚¬', team=Team10_2_7{id='team1', name='íŒ€A'}}]
team.getMembers() = [Member10_2_7{id='member1', username='ë©¤ë²„ì¼', team=Team10_2_7{id='team1', name='íŒ€A'}}, Member10_2_7{id='member4', username='ë©¤ë²„ì‚¬', team=Team10_2_7{id='team1', name='íŒ€A'}}]
team.getMembers() = [Member10_2_7{id='member2', username='ë©¤ë²„ì´', team=Team10_2_7{id='team2', name='íŒ€B'}}, Member10_2_7{id='member5', username='ë©¤ë²„ì˜¤', team=Team10_2_7{id='team2', name='íŒ€B'}}]
team.getMembers() = [Member10_2_7{id='member2', username='ë©¤ë²„ì´', team=Team10_2_7{id='team2', name='íŒ€B'}}, Member10_2_7{id='member5', username='ë©¤ë²„ì˜¤', team=Team10_2_7{id='team2', name='íŒ€B'}}]
team.getMembers() = [Member10_2_7{id='member3', username='ë©¤ë²„ì‚¼', team=Team10_2_7{id='team3', name='íŒ€C'}}, Member10_2_7{id='member6', username='ë©¤ë²„ìœ¡', team=Team10_2_7{id='team3', name='íŒ€C'}}]
team.getMembers() = [Member10_2_7{id='member3', username='ë©¤ë²„ì‚¼', team=Team10_2_7{id='team3', name='íŒ€C'}}, Member10_2_7{id='member6', username='ë©¤ë²„ìœ¡', team=Team10_2_7{id='team3', name='íŒ€C'}}]

```
ê²°ê³¼ëŠ” ì˜¬ë°”ë¥´ê²Œ ì¶œë ¥ëœë‹¤.

#### ğŸ”ºDTO ë¡œ ê°€ì ¸ì˜¤ê¸°
DTOë¥¼ ì‚¬ìš©í•´ì„œ ê°€ì ¸ì˜¤ë©´ Entityë¥¼ ì¡°íšŒí•œ ê²ƒì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì— ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ëŠ” ê´€ë ¨ì´ ì—†ì–´ì„œ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
Fetch join ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  join ì„ ì‚¬ìš©í•´ì•¼í•œë‹¤.
joinì„ ì‚¬ìš©í•˜ë”ë¼ë„, ì¦‰ì‹œ ë¡œë”©í•œ ê²ƒì²˜ëŸ¼ ëª¨ë“  ë°ì´í„°ë¥¼ DTOì— ë„£ì–´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
```java
public class TeamDTO {

    private String id;
    private String name;
    private String memberId;
    private String memberName;

    public TeamDTO(String id, String name, String memberId, String memberName) {
        this.id = id;
        this.name = name;
        this.memberId = memberId;
        this.memberName = memberName;
    }
	//...getter setter
}    
private static void getTeamDTO(EntityManager em) {
	List<Team10_2_7> teams =
    	em.createQuery("select distinct t from Team10_2_7 t join fetch t.members m "
        	+ "where m.username='ë©¤ë²„ì¼'",
            	Team10_2_7.class).getResultList(); //ë„Œ ì‚¬ìš©í•˜ì§€ ì•Šì„í…Œë‹¤.

	List<TeamDTO> teams2 =
    	em.createQuery(
        	"select new jpabook.start.chapter10_2_7.TeamDTO(t.id, t.name, m.id, m.username)"
            +"from Team10_2_7 t join t.members m "
            	, TeamDTO.class).getResultList();

	for (TeamDTO team : teams2) {
    	System.out.println("teams2 = " + teams2);
	}
}
```
ìˆ˜í–‰ì‹œ
```sql
/* select
        new jpabook.start.chapter10_2_7.TeamDTO(t.id,
        t.name,
        m.id,
        m.username) 
    from
        Team10_2_7 t 
    join
        t.members m  */ 
        select
            team10_2_7x0_.TEAM_ID as col_0_0_,
            team10_2_7x0_.name as col_1_0_,
            members1_.MEMBER_ID as col_2_0_,
            members1_.username as col_3_0_ 
        from
            Team10_2_7 team10_2_7x0_ 
        inner join
            Member10_2_7 members1_ 
                on team10_2_7x0_.TEAM_ID=members1_.TEAM_ID
teams2 = [TeamDTO{id='team1', name='íŒ€A', memberId='member1', memberName='ë©¤ë²„ì¼'}, TeamDTO{id='team1', name='íŒ€A', memberId='member4', memberName='ë©¤ë²„ì‚¬'}, TeamDTO{id='team2', name='íŒ€B', memberId='member2', memberName='ë©¤ë²„ì´'}, TeamDTO{id='team2', name='íŒ€B', memberId='member5', memberName='ë©¤ë²„ì˜¤'}, TeamDTO{id='team3', name='íŒ€C', memberId='member3', memberName='ë©¤ë²„ì‚¼'}, TeamDTO{id='team3', name='íŒ€C', memberId='member6', memberName='ë©¤ë²„ìœ¡'}]
teams2 = [TeamDTO{id='team1', name='íŒ€A', memberId='member1', memberName='ë©¤ë²„ì¼'}, TeamDTO{id='team1', name='íŒ€A', memberId='member4', memberName='ë©¤ë²„ì‚¬'}, TeamDTO{id='team2', name='íŒ€B', memberId='member2', memberName='ë©¤ë²„ì´'}, TeamDTO{id='team2', name='íŒ€B', memberId='member5', memberName='ë©¤ë²„ì˜¤'}, TeamDTO{id='team3', name='íŒ€C', memberId='member3', memberName='ë©¤ë²„ì‚¼'}, TeamDTO{id='team3', name='íŒ€C', memberId='member6', memberName='ë©¤ë²„ìœ¡'}]
teams2 = [TeamDTO{id='team1', name='íŒ€A', memberId='member1', memberName='ë©¤ë²„ì¼'}, TeamDTO{id='team1', name='íŒ€A', memberId='member4', memberName='ë©¤ë²„ì‚¬'}, TeamDTO{id='team2', name='íŒ€B', memberId='member2', memberName='ë©¤ë²„ì´'}, TeamDTO{id='team2', name='íŒ€B', memberId='member5', memberName='ë©¤ë²„ì˜¤'}, TeamDTO{id='team3', name='íŒ€C', memberId='member3', memberName='ë©¤ë²„ì‚¼'}, TeamDTO{id='team3', name='íŒ€C', memberId='member6', memberName='ë©¤ë²„ìœ¡'}]
... ì´ 6ë²ˆ ì¶œë ¥ë¨
```



ğŸ’¡ì°¸ê³ 
https://programmer93.tistory.com/83
https://stir.tistory.com/288
