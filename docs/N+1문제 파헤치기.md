## âœ” N+1ë¬¸ì œë€?
ì—°ê´€ê´€ê³„ê°€ ì„¤ì •ëœ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ê²½ìš°ì— ì¡°íšŒí•œ ë°ì´í„° ê°¯ìˆ˜(N)ë§Œí¼ ì—°ê´€ê´€ê³„ì˜ ì¶”ê°€ì¿¼ë¦¬ê°€ ì¶”ê°€ë¡œ ë°œìƒí•˜ì—¬ ë°ì´í„°ë¥¼ ì½ì–´ì˜¤ëŠ” í˜„ìƒ

## âœ”ì–¸ì œ ë°œìƒí• ê¹Œìš”?
@ManyToOne ê´€ê³„ë¥¼ ê°€ì§„ ì—”í‹°í‹°ì—ì„œ ì£¼ë¡œ ë°œìƒí•œë‹¤.
ë°ì´í„° ì¡°íšŒì‹œ 
- ì¦‰ì‹œ ë¡œë”©ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²½ìš°ëŠ” N+1í˜„ìƒì´ ë°”ë¡œ ë°œìƒí•œë‹¤.
- ì§€ì—°ë¡œë”©ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ ì´í›„ì— ê°€ì ¸ì˜¨ ë°ì´í„°ì—ì„œ í•˜ìœ„ ì—”í‹°í‹°ë¥¼ ë‹¤ì‹œ ì¡°íšŒí•˜ëŠ” ê²½ìš° N+1í˜„ìƒì´ ë°œìƒí•œë‹¤.

## âœ” N+1 í˜„ìƒ ì¬í˜„í•´ë³´ê¸°.
í•­ìƒí•˜ëŠ” Memberì™€ Teamìœ¼ë¡œ ì¬í˜„í•´ë³´ê² ë‹¤.
```java
@Entity
public class Member10_2_7 {

    @Id
    @Column(name = "MEMBER_ID")
    private String id;
    private String username;

    @ManyToOne
    @JoinColumn(name = "TEAM_ID")
    private Team10_2_7 team;

    public Member10_2_7() {
    }

    public Member10_2_7(String id, String username) {
        this.id = id;
        this.username = username;
    }
	//...getter, setter
}
@Entity
public class Team10_2_7 {

    @Id
    @Column(name = "TEAM_ID")
    private String id;
    private String name;

    @OneToMany(mappedBy = "team")
    private List<Member10_2_7> members = new ArrayList<>();

    public Team10_2_7() {
    }

    public Team10_2_7(String id, String name) {
        this.id = id;
        this.name = name;
    }

    public List<Member10_2_7> getMembers() {
        return members;
    }
    //...getter, setter
}

private static void save(EntityManager em) {
        Member10_2_7 member1 = new Member10_2_7("member1", "ë©¤ë²„ì¼");
        Member10_2_7 member2 = new Member10_2_7("member2", "ë©¤ë²„ì´");
        Member10_2_7 member3 = new Member10_2_7("member3", "ë©¤ë²„ì‚¼");

        em.persist(member1);
        em.persist(member2);
        em.persist(member3);

        Team10_2_7 team = new Team10_2_7("team1", "íŒ€A");
        em.persist(team);
        Team10_2_7 team2 = new Team10_2_7("team2", "íŒ€B");
        em.persist(team2);

        Team10_2_7 team3 = new Team10_2_7("team3", "íŒ€C");
        em.persist(team3);

        member1.setTeam(team);
        member2.setTeam(team2);
        member3.setTeam(team3);

}

```
![](https://velog.velcdn.com/images/baeyuyeon/post/62daec9f-db29-4663-aec7-099afe0b26fb/image.png)
ë©¤ë²„ê°€ í•œ íŒ€ì— ì†Œì†ë˜ì–´ìˆê³  í•œ íŒ€ì€ ì—¬ëŸ¬ ë©¤ë²„ë¥¼ í¬í•¨í•  ìˆ˜ ìˆëŠ” N:1(ë©¤ë²„:íŒ€)ê´€ê³„ì´ë‹¤.

ë°ì´í„°ëŠ” ë©¤ë²„ ê°ê°ì´ ë‹¤ë¥¸ íŒ€ì— ì†í•˜ë„ë¡ ì €ì¥í•˜ì˜€ë‹¤.
![](https://velog.velcdn.com/images/baeyuyeon/post/9fba5007-225f-4575-a0ae-ae46b98fc111/image.png)
![](https://velog.velcdn.com/images/baeyuyeon/post/dfc21093-30dc-4740-9ad8-c47f1530f312/image.png)



### ğŸ”»ì¦‰ì‹œë¡œë”©ì¼ ê²½ìš°
Memberì˜ Team ê°ì²´ ì°¸ì¡°ëŠ” @ManyToOneë¡œ ì—°ê´€ê´€ê³„ê°€ ì„¤ì •ë˜ì–´ìˆë‹¤. `@ManyToOne`ì˜ ê¸°ë³¸ íŒ¨ì¹˜ ì „ëµì€ ì¦‰ì‹œë¡œë”©ì´ë¯€ë¡œ ë³„ë„ ì„¤ì •ì„ í•˜ì§€ ì•Šê³  ì¡°íšŒë¥¼ í•´ë³´ê² ë‹¤.

```java
String query2 = "SELECT m FROM Member10_2_7 m inner join m.team t";

List<Member10_2_7> members = em.createQuery(query2, Member10_2_7.class).getResultList();
```
ìœ„ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ ì¿¼ë¦¬ê°€ ìˆ˜í–‰ëœë‹¤.
```sql
Hibernate: 
    select
            member10_2x0_.MEMBER_ID as MEMBER_I1_20_,
            member10_2x0_.TEAM_ID as TEAM_ID3_20_,
            member10_2x0_.username as username2_20_ 
        from
            Member10_2_7 member10_2x0_ 
        inner join
            Team10_2_7 team10_2_7x1_ 
                on member10_2x0_.TEAM_ID=team10_2_7x1_.TEAM_ID
Hibernate: 
    select
        team10_2_7x0_.TEAM_ID as TEAM_ID1_47_0_,
        team10_2_7x0_.name as name2_47_0_ 
    from
        Team10_2_7 team10_2_7x0_ 
    where
        team10_2_7x0_.TEAM_ID=?
Hibernate: 
    select
        team10_2_7x0_.TEAM_ID as TEAM_ID1_47_0_,
        team10_2_7x0_.name as name2_47_0_ 
    from
        Team10_2_7 team10_2_7x0_ 
    where
        team10_2_7x0_.TEAM_ID=?
Hibernate: 
    select
        team10_2_7x0_.TEAM_ID as TEAM_ID1_47_0_,
        team10_2_7x0_.name as name2_47_0_ 
    from
        Team10_2_7 team10_2_7x0_ 
    where
        team10_2_7x0_.TEAM_ID=?

```
ì¦‰, ë©¤ë²„ì— ì—°ê´€ëœ íŒ€ì˜ ê°œìˆ˜(3)ë§Œí¼ 3ê°œì˜ ì¿¼ë¦¬ê°€ ì¶”ê°€ë¡œ ë°œìƒí•˜ëŠ” N+1í˜„ìƒì´ ë°œìƒí•œë‹¤.

### ğŸ”»ì§€ì—°ë¡œë”©ì¼ ê²½ìš°
ìš°ì„  ì§€ì—°ë¡œë”©ì„¤ì •ì„ ìœ„í•´ Memberì—ì„œ team ì°¸ì¡° íŒ¨ì¹˜ì „ëµì„ ì§€ì—°ë¡œë”©ìœ¼ë¡œ ì„¤ì •í•´ë‘ì.
`@ManyToOne(fetch = FetchType.LAZY)`ë¡œ ì„¤ì •!
ì„¤ì •í•œ í›„, ìœ„ì™€ ë˜‘ê°™ì´ ì¡°íšŒ ì½”ë“œë¥¼ ë‚ ë¦¬ë©´ ì–´ë–»ê²Œ ë ê¹Œ?
```java
String query2 = "SELECT m FROM Member10_2_7 m inner join m.team t";

List<Member10_2_7> members = em.createQuery(query2, Member10_2_7.class).getResultList();
```
```sql
Hibernate: 
    select
            member10_2x0_.MEMBER_ID as MEMBER_I1_20_,
            member10_2x0_.TEAM_ID as TEAM_ID3_20_,
            member10_2x0_.username as username2_20_ 
       from
           Member10_2_7 member10_2x0_ 
       inner join
           Team10_2_7 team10_2_7x1_ 
               on member10_2x0_.TEAM_ID=team10_2_7x1_.TEAM_ID
```
ìš°ë¦¬ê°€ ì›í•˜ë˜ëŒ€ë¡œ ì¿¼ë¦¬ê°€ 1ë²ˆë§Œ ì‹¤í–‰ì´ ë˜ì—ˆë‹¤! ì´ë ‡ê²Œ N+1í˜„ìƒì€ ë°œìƒë˜ì§€ ì•Šì„ê¹Œ?
_ê·¸ë ‡ì§€ ì•Šë‹¤._
ì´ì œ Memberì˜ íŒ€ëª…ì„ ì¡°íšŒí•˜ëŠ” ì½”ë“œë¥¼ ì¶”ê°€í•´ë³´ì.
```java
for (Member10_2_7 member : members) {
	Team10_2_7 team = member.getTeam();
    String name = team.getName();
    System.out.println("name = " + name);
}
```
ìœ„ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´,
```sql
Hibernate: 
    select
        team10_2_7x0_.TEAM_ID as TEAM_ID1_47_0_,
        team10_2_7x0_.name as name2_47_0_ 
    from
        Team10_2_7 team10_2_7x0_ 
    where
        team10_2_7x0_.TEAM_ID=?
name = íŒ€A
Hibernate: 
    select
        team10_2_7x0_.TEAM_ID as TEAM_ID1_47_0_,
        team10_2_7x0_.name as name2_47_0_ 
    from
        Team10_2_7 team10_2_7x0_ 
    where
        team10_2_7x0_.TEAM_ID=?
name = íŒ€B
Hibernate: 
    select
        team10_2_7x0_.TEAM_ID as TEAM_ID1_47_0_,
        team10_2_7x0_.name as name2_47_0_ 
    from
        Team10_2_7 team10_2_7x0_ 
    where
        team10_2_7x0_.TEAM_ID=?
name = íŒ€C
```
ì—­ì‹œ íŒ€ì˜ ê°œìˆ˜ë§Œí¼ Nê°œì˜ ì¶”ê°€ ì¿¼ë¦¬ê°€ ë°œìƒí•œë‹¤.

## âœ” N+1í˜„ìƒ í•´ê²°ë°©ë²•
N+1í˜„ìƒ í•´ê²°ë°©ë²•ì€ ëŒ€í‘œì ìœ¼ë¡œ ì„¸ê°€ì§€ê°€ ìˆëŠ”ë°, Fetch join ì‚¬ìš©, @EntityGraph, Batch Size ì˜µì…˜ ì„¤ì •ë°©ë²•ì´ ìˆë‹¤.
í•´ë‹¹ ê¸€ì—ì„œëŠ” Fetch joinë§Œ ì„¤ëª…í•˜ê³  ë‚˜ë¨¸ì§€ ë°©ë²•ì€ ì¶”í›„ ì¶”ê°€í•˜ê² ë‹¤.
## âœ” Fetch join 
### ğŸ”¶Fetch Join ì´ë€?
Fetchë€ ê°€ì ¸ì˜¤ë‹¤ë¼ëŠ” ëœ»ì´ë‹¤. Fetchë¼ëŠ” ëœ»ì— ê±¸ë§ê²Œ íŒ¨ì¹˜ì¡°ì¸ì„ ì‚¬ìš©í•˜ë©´ ì—°ê´€ëœ Entity ë¥¼ ëª¨ë‘ ì¦‰ì‹œ ë¡œë”©ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.

### ğŸ”¶Fetch Join ì‚¬ìš©í•˜ê¸°
join fetch ì´ë¼ëŠ” êµ¬ë¬¸ì„ ì‚¬ìš©í•´ì„œ ë°ì´í„°ë¥¼ ì¡°íšŒí•œë‹¤.

```java
private static void fetchJoin(EntityManager em) {
	String query = "select m from Member10_2_7 m join fetch m.team";

    List<Member10_2_7> members = em.createQuery(query,  Member10_2_7.class).getResultList();

	System.out.println("members = " + members);
}
    
```
ìœ„ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´?
```sql
select
            member10_2x0_.MEMBER_ID as MEMBER_I1_20_0_,
            team10_2_7x1_.TEAM_ID as TEAM_ID1_47_1_,
            member10_2x0_.TEAM_ID as TEAM_ID3_20_0_,
            member10_2x0_.username as username2_20_0_,
            team10_2_7x1_.name as name2_47_1_ 
        from
            Member10_2_7 member10_2x0_ 
        inner join
            Team10_2_7 team10_2_7x1_ 
                on member10_2x0_.TEAM_ID=team10_2_7x1_.TEAM_ID
                
members = [Member10_2_7{id='member1', username='ë©¤ë²„ì¼', team=Team10_2_7{id='team1', name='íŒ€A'}}, Member10_2_7{id='member2', username='ë©¤ë²„ì´', team=Team10_2_7{id='team2', name='íŒ€B'}}, Member10_2_7{id='member3', username='ë©¤ë²„ì‚¼', team=Team10_2_7{id='team3', name='íŒ€C'}}]
```
ì´ì™€ ê°™ì´ 1ê°œì˜ ì¿¼ë¦¬ë§Œ ì‹¤í–‰ë˜ì–´ í•œë²ˆì— ëª¨ë“  ë°ì´í„°ë¥¼ ë‹¤ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.

### ğŸ”¶Fetch Join ì‚¬ìš©ì‹œ ì£¼ì˜ì  - on ì‚¬ìš© ê¸ˆì§€
```sql
select m from Member10_2_7 m join fetch m.team t on t.name='íŒ€B'";
```
ë‹¤ìŒê³¼ ê°™ì´ onì„ ì‚¬ìš©í•˜ì§€ ë§ë¼ëŠ”ë§ì´ë‹¤._(ìœ„ ì¿¼ë¦¬ì—ëŠ” ì‚¬ì‹¤ ë‘ê°€ì§€ì˜ ë¬¸ì œê°€ ìˆë‹¤.)_
Onì ˆì€ Joinì´ ë˜ê¸°ì „ í•„í„°ë§ì„ ê±°ëŠ” ê²ƒì¸ë°, Fetch Join ì€ ì—°ê´€ëœ Entityë‚˜ Collectionì„ ëª¨ë‘ ê°€ì ¸ì˜¨ë‹¤ëŠ” ì˜ë¯¸ë¡œ onì€ ë¶ˆê°€ëŠ¥í•˜ë‹¤.
ë”°ë¼ì„œ whereì ˆì„ ì‚¬ìš©í•´ì„œ ì´ë¯¸ ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ í•„í„°ë§í•˜ë©´ ëœë‹¤.
**ê·¸ë ‡ì§€ë§Œ, whereì ˆì„ í†µí•´ì„œ Entityì˜ ìƒíƒœê°€ ì†ìƒë  ìˆ˜ ìˆì–´ì„œ ì£¼ì˜í•´ì„œ ì‚¬ìš©í•´ì•¼í•œë‹¤.**

### ğŸ”¶Fetch Join ì‚¬ìš©ì‹œ ì£¼ì˜ì  - Fetch Join ëŒ€ìƒì— ë³„ì¹­ì£¼ê¸° ê¸ˆì§€

JPA ìŠ¤í™ì—ì„œëŠ” Fetch Join ëŒ€ìƒì— ë³„ì¹­ì„ ì£¼ëŠ” ê²ƒì„ ê¸ˆì§€í•˜ê³  ìˆë‹¤.
ì™œëƒí•˜ë©´ ë³„ì¹­ì„ ì´ìš©í•´ whereì¡°ê±´ì„ ì‚¬ìš©í•˜ë©´ ì—°ê´€ëœ Entityê°€ ì†ìƒë  ìˆ˜ ìˆê³ , DBì¼ê´€ì„±ì— ì˜í–¥ì´ ìƒê¸¸ ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤.
```sql
select m from Member10_2_7 m join fetch m.team t where t.name='íŒ€B'
```
ìœ„ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´?
```sql
select
	member10_2x0_.MEMBER_ID as MEMBER_I1_20_0_,
    team10_2_7x1_.TEAM_ID as TEAM_ID1_47_1_,
    member10_2x0_.TEAM_ID as TEAM_ID3_20_0_,
    member10_2x0_.username as username2_20_0_,
    team10_2_7x1_.name as name2_47_1_ 
from
	Member10_2_7 member10_2x0_ 
    inner join
	Team10_2_7 team10_2_7x1_ 
    	on member10_2x0_.TEAM_ID=team10_2_7x1_.TEAM_ID 
where
	team10_2_7x1_.name='íŒ€B'
```
ì˜ë§Œ ì‹¤í–‰ëœë‹¤... ê·¸ ì´ìœ ëŠ”, JPAêµ¬í˜„ì²´ì¸ Hibernateì—ì„œ Fetch Join ì˜ ëŒ€ìƒì— Aliasë¥¼ ì£¼ëŠ” ê²ƒì„ í—ˆìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì´ë‹¤.
ê·¸ë ‡ì§€ë§Œ ì•ˆì“°ëŠ”ê²Œ ì¢‹ìœ¼ë‹ˆ, Entityì˜ ìˆœì„œë¥¼ ë°”ê¿”ì„œ Fetch Joinì˜ ëŒ€ìƒì´ ì•ˆë˜ë„ë¡ ë°”ê¿”ë³´ì.
`select t from Team10_2_7 t join fetch t.members where t.name='íŒ€B'`

